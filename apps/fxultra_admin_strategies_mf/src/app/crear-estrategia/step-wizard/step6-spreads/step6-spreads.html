<div class="spreads-container">

  <!-- ===== Título ===== -->
  <div class="titulo">
    Configura los spreads por horario definido previamente
  </div>

  <!-- ===== Controles superiores ===== -->
  <div class="controles-superiores">
    <span class="switch-label">Spreads en % (porcentajes)</span>
    <label class="switch">
      <input type="checkbox" [(ngModel)]="usarPorcentaje" />
      <span class="slider"></span>
    </label>
  </div>

  <!-- ===== Mismos spreads (modal) ===== -->
  <label class="check-todos">
    <input
      type="checkbox"
      class="custom-checkbox"
      [checked]="mismosSpreadsTodos"
      (change)="abrirModalMismosSpreads($event)"
    />
    <span class="checkbox-custom"></span>
    <span class="check-todos-label">Mismos spreads todas los pares de divisas (excepto Yen japonés)</span>
  </label>

  <!-- ===== Tabla principal ===== -->
  <div class="tabla-wrapper">
    <table class="tabla-spreads" role="table">
      <thead>
        <tr>
          <th class="col-check th-left"></th>
          <th class="col-par th-left">Par</th>
          <th class="col-horarios th-left">Horarios operativos</th>
          <th class="col-spread th-left">
            Spread Venta<br><span class="sub">Monex entrega</span>
          </th>
          <th class="col-spread th-left">
            Spread Compra<br><span class="sub">Monex recibe</span>
          </th>
          <th class="col-edit th-left"></th>
        </tr>
      </thead>

      <tbody>
        <ng-container *ngFor="let g of grupos; let gi = index">
          <tr *ngFor="let f of g.filas; let fi = index">
            <td class="col-check">
              <!-- ===== Checkbox por par (oculta JPY) ===== -->
              <ng-container *ngIf="fi === 0 && g.nombre !== excluido">
                <label class="par-checkbox par-checkbox--tabla">
                  <input
                    type="checkbox"
                    class="custom-checkbox"
                    [(ngModel)]="g.seleccionado"
                  />
                  <span class="checkbox-custom"></span>
                </label>
              </ng-container>
            </td>

            <td class="col-par">
              <ng-container *ngIf="fi === 0">{{ g.nombre }}</ng-container>
            </td>

            <td class="col-horarios">
              <span class="hora">{{ f.inicio }}</span>
              <i class="flecha fas fa-arrow-right" aria-hidden="true"></i>
              <span class="hora">{{ f.fin }}</span>
            </td>

            <!-- ===== Columna Vende ===== -->
            <td class="col-spread">
              <div
                class="spread-box"
                [class.error]="hasFieldError(gi, fi, 'vende') || (showAlertaCeros && puedeEditar(g.nombre,'vende') && isZero(f.vende, g.nombre))"
                [class.disabled]="!puedeEditar(g.nombre,'vende')"
              >
                <div class="valor-wrap" *ngIf="!f.edit || !puedeEditar(g.nombre,'vende'); else edicionVende">
                  <span class="valor">{{ f.vende }}</span>
                </div>
                <ng-template #edicionVende>
                  <input
                    class="input-spread"
                    [class.error]="hasFieldError(gi, fi, 'vende') || (showAlertaCeros && puedeEditar(g.nombre,'vende') && isZero(f.vende, g.nombre))"
                    type="text"
                    [disabled]="!puedeEditar(g.nombre,'vende')"
                    [value]="f.vende"
                    (focus)="startEditing(gi, fi, 'vende')"
                    (input)="onInputSpread(gi, fi, 'vende', $event)"
                    (keydown)="permitirTeclasNumericas($event)"
                    (keydown.enter)="onEnterGuardar(gi, fi, $any($event))"
                    (blur)="normalizarBlur(gi, fi, 'vende', $event)"
                    inputmode="decimal"
                    autocomplete="off" />
                </ng-template>
              </div>
            </td>

            <!-- ===== Columna Compra ===== -->
            <td class="col-spread">
              <div
                class="spread-box"
                [class.error]="hasFieldError(gi, fi, 'compra') || (showAlertaCeros && puedeEditar(g.nombre,'compra') && isZero(f.compra, g.nombre))"
                [class.disabled]="!puedeEditar(g.nombre,'compra')"
              >
                <div class="valor-wrap" *ngIf="!f.edit || !puedeEditar(g.nombre,'compra'); else edicionCompra">
                  <span class="valor">{{ f.compra }}</span>
                </div>
                <ng-template #edicionCompra>
                  <input
                    class="input-spread"
                    [class.error]="hasFieldError(gi, fi, 'compra') || (showAlertaCeros && puedeEditar(g.nombre,'compra') && isZero(f.compra, g.nombre))"
                    type="text"
                    [disabled]="!puedeEditar(g.nombre,'compra')"
                    [value]="f.compra"
                    (focus)="startEditing(gi, fi, 'compra')"
                    (input)="onInputSpread(gi, fi, 'compra', $event)"
                    (keydown)="permitirTeclasNumericas($event)"
                    (keydown.enter)="onEnterGuardar(gi, fi, $any($event))"
                    (blur)="normalizarBlur(gi, fi, 'compra', $event)"
                    inputmode="decimal"
                    autocomplete="off" />
                </ng-template>
              </div>
            </td>

            <!-- ===== Acciones por fila ===== -->
            <td class="col-edit">
              <button
                class="icon-btn"
                *ngIf="!f.edit"
                [disabled]="!puedeEditar(g.nombre,'vende') && !puedeEditar(g.nombre,'compra')"
                (click)="habilitarEdicion(gi, fi)"
              >
                <i class="fa-solid fa-pen-to-square"></i>
                <span class="tooltip">Edita registro</span>
              </button>
              <button class="icon-btn guardar" *ngIf="f.edit" (click)="guardarFila(gi, fi)">
                <i class="fas fa-save"></i>
                <span class="tooltip">Guarda registro</span>
              </button>
            </td>
          </tr>
        </ng-container>
      </tbody>
    </table>
  </div>

  <!-- ===== Mensajes de error ===== -->
  <div class="alerta-wrapper">
    <div *ngIf="alerta.tipo !== 'none'" class="mensaje-error">
      <i class="fas fa-exclamation-circle"></i>
      <span class="strong" *ngIf="alerta.tipo === 'decimales'">Solo se permiten ingresar {{alerta.max}} decimales</span>
      <span class="strong" *ngIf="alerta.tipo === 'decimales_min'">No se permite capturar menos de {{alerta.max}} decimales</span>
      <span class="strong" *ngIf="alerta.tipo === 'caracteres'">No se permiten ingresar caracteres especiales y/o valores negativos</span>
      <span class="strong" *ngIf="alerta.tipo === 'entero'">Valor no permitido para el spread</span>
    </div>

    <div *ngIf="showAlertaCeros" class="mensaje-error">
      <i class="fas fa-exclamation-circle"></i>
      <span class="strong">Asignar spread para cada una de las divisas</span>
    </div>
  </div>

  <!-- ===== Acciones ===== -->
  <div class="acciones">
    <button class="btn-principal" (click)="aplicarConfiguracion()">Aplicar configuración</button>
    <span class="restablecer" (click)="abrirModalReset()">Restablecer</span>
  </div>

  <!-- ===== Progreso ===== -->
  <div class="subinfo-row"><span class="progreso">Paso 6 de 7</span></div>
</div>

<!-- ===== Modal Mismos Spreads ===== -->
<div class="modal-backdrop" *ngIf="mostrarModalMismosSpreads" (click)="cerrarModal(false)"></div>
<div
  class="modal-contenedor"
  *ngIf="mostrarModalMismosSpreads"
  role="dialog"
  aria-modal="true"
  aria-label="Mismos spreads"
  (click)="$event.stopPropagation()"
  [class.con-jpy]="incluirJPY && tieneJPY"
  style="width: 326px;"
>
  <button
    class="modal-cerrar"
    type="button"
    (click)="cerrarModal(false); $event.stopPropagation()"
    aria-label="Cerrar"
    title="Cerrar"
  >
    <svg class="modal-cerrar__icon" width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M18 6L6 18M6 6l12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>

  <div class="modal-body">
    <div class="modal-titulo">Spreads globales</div>
    <p class="modal-desc">Captura los spreads que apliquen a todos los pares seleccionados</p>

    <!-- ===== Tabla modal (pares no JPY) ===== -->
    <div class="modal-tabla-wrapper">
      <table class="modal-tabla">
        <thead>
          <tr>
            <th>Spread Venta<span class="sub">Monex entrega</span></th>
            <th>Spread Compra<span class="sub">Monex recibe</span></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <input
                type="text"
                class="input-modal"
                [value]="modalTodos.vende"
                (input)="onInputModal('todos','vende',$event)"
                (keydown)="permitirTeclasNumericas($event)"
                (blur)="normalizarModal('todos','vende',$event)"
                inputmode="decimal"
                autocomplete="off"
                placeholder="0.0000" />
            </td>
            <td>
              <input
                type="text"
                class="input-modal"
                [value]="modalTodos.compra"
                (input)="onInputModal('todos','compra',$event)"
                (keydown)="permitirTeclasNumericas($event)"
                (blur)="normalizarModal('todos','compra',$event)"
                inputmode="decimal"
                autocomplete="off"
                placeholder="0.0000" />
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ===== Switch JPY ===== -->
    <div class="switch-jpy">
      <span class="switch-jpy-label">Seleccionar JPY</span>
      <label class="switch">
        <input type="checkbox" [(ngModel)]="incluirJPY" [disabled]="!tieneJPY" />
        <span class="slider"></span>
      </label>
    </div>

    <!-- ===== Tabla modal (JPY) ===== -->
    <div class="modal-tabla-wrapper" *ngIf="tieneJPY && incluirJPY">
      <table class="modal-tabla">
        <thead>
          <tr>
            <th>Spread Venta<span class="sub">Monex entrega</span></th>
            <th>Spread Compra<span class="sub">Monex recibe</span></th>
          </tr>
        </thead>
        <tbody>
          <tr>
            <td>
              <input
                type="text"
                class="input-modal"
                [value]="modalJPY.vende"
                (input)="onInputModal('jpy','vende',$event)"
                (keydown)="permitirTeclasNumericas($event)"
                (blur)="normalizarModal('jpy','vende',$event)"
                inputmode="decimal"
                autocomplete="off"
                placeholder="0.000000" />
            </td>
            <td>
              <input
                type="text"
                class="input-modal"
                [value]="modalJPY.compra"
                (input)="onInputModal('jpy','compra',$event)"
                (keydown)="permitirTeclasNumericas($event)"
                (blur)="normalizarModal('jpy','compra',$event)"
                inputmode="decimal"
                autocomplete="off"
                placeholder="0.000000" />
            </td>
          </tr>
        </tbody>
      </table>
    </div>

    <!-- ===== Footer modal ===== -->
    <div class="modal-footer">
      <button class="btn-principal btn-modal" (click)="aplicarModal()">Aplicar spreads</button>
    </div>
  </div>
</div>

<!-- ===== Modal Reset ===== -->
<div class="modal-backdrop" *ngIf="mostrarModalReset" (click)="cerrarModalReset(false)"></div>
<div
  class="modal-contenedor modal-reset"
  *ngIf="mostrarModalReset"
  role="dialog"
  aria-modal="true"
  aria-label="Restablecer valores"
  (click)="$event.stopPropagation()"
>
  <button
    class="modal-cerrar"
    type="button"
    (click)="cerrarModalReset(false); $event.stopPropagation()"
    aria-label="Cerrar"
    title="Cerrar"
  >
    <svg class="modal-cerrar__icon" width="20" height="20" viewBox="0 0 24 24" aria-hidden="true">
      <path d="M18 6L6 18M6 6l12 12" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
    </svg>
  </button>

  <div class="modal-body">
    <div class="modal-titulo">Restablecer valores</div>
    <p class="modal-desc" style="text-align:center">
      ¿Estas seguro de restablecer el registro de spreads a la compra y venta?
    </p>

    <div class="modal-footer modal-footer--reset">
      <button type="button" class="btn-cancel-link" (click)="cerrarModalReset(false)">Cancelar</button>
      <button class="btn-principal btn-modal" (click)="confirmarReset()">Sí, restablecer</button>
    </div>
  </div>
</div>

<!-- ===== Modal OK pequeño ===== -->
<div class="modal-overlay" *ngIf="mostrarModalOk" (click)="cerrarModalOk()">
  <div class="modal-ok" (click)="$event.stopPropagation()">
    <button class="modal-ok__close" (click)="cerrarModalOk()" aria-label="Cerrar" title="Cerrar">×</button>
    <div class="modal-ok__title">Datos actualizados exitosamente</div>
    <button class="btn-principal modal-ok__btn" (click)="cerrarModalOk()">Aceptar</button>
  </div>
</div>
